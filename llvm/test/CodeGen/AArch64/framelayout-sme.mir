# RUN: llc -mattr=+sve,+sme -mtriple=aarch64-none-linux-gnu -run-pass=prologepilog %s -o - | FileCheck %s
#
--- |
  define void @test_allocate_sme_d() { entry: unreachable }
  define void @test_allocate_sme_h() { entry: unreachable }
  define void @test_allocate_sme_w() { entry: unreachable }
  define void @test_allocate_sme_b() { entry: unreachable }
...
# CHECK-LABEL: name: test_allocate_sme_d
# CHECK:       stackSize: 32
# CHECK:       bb.0.entry:
# CHECK-NEXT:  $sp = frame-setup STRXpre killed $[[SCRATCH:[a-z0-9]+]], $sp, -16
# CHECK-NEXT:  $sp, dead $x8 = frame-setup SME_ALLOCA_D $sp, -1
# CHECK-NEXT:  $sp = frame-setup SUBXri $sp, 16, 0
# CHECK-COUNT-2: frame-setup CFI_INSTRUCTION

# CHECK-NEXT: $sp, dead $x8 = frame-destroy SME_ALLOCA_D $sp, 1
# CHECK-NEXT: $sp = frame-destroy ADDXri $sp, 16, 0
# CHECK-NEXT: $sp, $[[SCRATCH]] = frame-destroy LDRXpost $sp, 16
# CHECK-NEXT: RET_ReallyLR
#

# ASM-LABEL: test_allocate_sme
# ASM:       .cfi_escape 0x0f, 0x0c, 0x8f, 0x00, 0x11, 0x20, 0x22, 0x11, 0x10, 0x92, 0x2e, 0x00, 0x1e, 0x22
# ASM-NEXT:  .cfi_offset w29, -16
name:          test_allocate_sme_d
stack:
    - { id: 0, stack-id: scalable-matrix, size: 32, alignment: 16 }
    - { id: 1, stack-id: default, size: 8, alignment: 16 }
body:                |
  bb.0.entry:
    RET_ReallyLR
---
...
#CHECK-LABEL: name: test_allocate_sme_h
# CHECK:       stackSize: 32
# CHECK:       bb.0.entry:
# CHECK-NEXT:  $sp = frame-setup STRXpre killed $[[SCRATCH:[a-z0-9]+]], $sp, -16
# CHECK-NEXT:  $sp, dead $x8 = frame-setup SME_ALLOCA_H $sp, -1
# CHECK-NEXT:  $sp = frame-setup SUBXri $sp, 16, 0
# CHECK-COUNT-2: frame-setup CFI_INSTRUCTION

# CHECK-NEXT: $sp, dead $x8 = frame-destroy SME_ALLOCA_H $sp, 1
# CHECK-NEXT: $sp = frame-destroy ADDXri $sp, 16, 0
# CHECK-NEXT: $sp, $[[SCRATCH]] = frame-destroy LDRXpost $sp, 16
# CHECK-NEXT: RET_ReallyLR
#

# ASM-LABEL: test_allocate_sme_h
# ASM:       .cfi_escape 0x0f, 0x0c, 0x8f, 0x00, 0x11, 0x20, 0x22, 0x11, 0x10, 0x92, 0x2e, 0x00, 0x1e, 0x22
# ASM-NEXT:  .cfi_offset w29, -16
name:          test_allocate_sme_h
stack:
     - { id: 0, stack-id: scalable-matrix, size: 128, alignment: 16 }
     - { id: 1, stack-id: default, size: 8, alignment: 16 }
body:                |
  bb.0.entry:
    RET_ReallyLR
---
...
# CHECK-LABEL: name: test_allocate_sme_w
# CHECK:       stackSize: 32
# CHECK:       bb.0.entry:
# CHECK-NEXT:  $sp = frame-setup STRXpre killed $[[SCRATCH:[a-z0-9]+]], $sp, -16
# CHECK-NEXT:  $sp, dead $x8 = frame-setup SME_ALLOCA_W $sp, -1
# CHECK-NEXT:  $sp = frame-setup SUBXri $sp, 16, 0
# CHECK-COUNT-2: frame-setup CFI_INSTRUCTION

# CHECK-NEXT: $sp, dead $x8 = frame-destroy SME_ALLOCA_W $sp, 1
# CHECK-NEXT: $sp = frame-destroy ADDXri $sp, 16, 0
# CHECK-NEXT: $sp, $[[SCRATCH]] = frame-destroy LDRXpost $sp, 16
# CHECK-NEXT: RET_ReallyLR
#

# ASM-LABEL: test_allocate_sme_w
# ASM:       .cfi_escape 0x0f, 0x0c, 0x8f, 0x00, 0x11, 0x20, 0x22, 0x11, 0x10, 0x92, 0x2e, 0x00, 0x1e, 0x22
# ASM-NEXT:  .cfi_offset w29, -16
name:          test_allocate_sme_w
stack:
    - { id: 0, stack-id: scalable-matrix, size: 64, alignment: 16 }
    - { id: 1, stack-id: default, size: 8, alignment: 16 }
body:                |
  bb.0.entry:
    RET_ReallyLR
---
...
# CHECK-LABEL: name: test_allocate_sme_b
# CHECK:       stackSize: 32
# CHECK:       bb.0.entry:
# CHECK-NEXT:  $sp = frame-setup STRXpre killed $[[SCRATCH:[a-z0-9]+]], $sp, -16
# CHECK-NEXT:  $sp, dead $x8 = frame-setup SME_ALLOCA_B $sp, -1
# CHECK-NEXT:  $sp = frame-setup SUBXri $sp, 16, 0
# CHECK-COUNT-2: frame-setup CFI_INSTRUCTION

# CHECK-NEXT: $sp, dead $x8 = frame-destroy SME_ALLOCA_B $sp, 1
# CHECK-NEXT: $sp = frame-destroy ADDXri $sp, 16, 0
# CHECK-NEXT: $sp, $[[SCRATCH]] = frame-destroy LDRXpost $sp, 16
# CHECK-NEXT: RET_ReallyLR
#

# ASM-LABEL: test_allocate_sme_b
# ASM:       .cfi_escape 0x0f, 0x0c, 0x8f, 0x00, 0x11, 0x20, 0x22, 0x11, 0x10, 0x92, 0x2e, 0x00, 0x1e, 0x22
# ASM-NEXT:  .cfi_offset w29, -16
name:          test_allocate_sme_b
stack:
    - { id: 0, stack-id: scalable-matrix, size: 256, alignment: 16 }
    - { id: 1, stack-id: default, size: 8, alignment: 16 }
body:                |
  bb.0.entry:
    RET_ReallyLR
---
